/*** BNFC-Generated contextor Traversal Skeleton. ***/
/* This traverses the abstract syntax tree.
   To use, copy Skeleton.h and Skeleton.c to
   new files. */

#include <stdio.h>
#include <stdlib.h>
#include "Context.h"
#include "symbols.h"
#include "Absyn.h"

#define SPOJNIK_AND 0
#define SPOJNIK_OR 1

//tymczasowe rozwi±zanie na szybko:
Zapytanie firstZapProste = NULL;

void contextZapZloz(ZapZloz _p_)
{
  contextListZapytanie(_p_->listzapytanie_);
  _p_->listzapytanie_ = make_ListZapytanie(firstZapProste, NULL);
}

Zapytanie polacz_zapytania(Zapytanie z1, Zapytanie z2, int spojnik){
printf ("spojnik: %d\n", spojnik);
    Zapytanie z = malloc(sizeof(struct Zapytanie_));
    int i;
    Wyraz w;
    if(z1->kind == is_ZapProste && z2->kind == is_ZapProste){
        for(i=0;i<ilePol();i++){
	  if(z2->u.zapproste_.tabliniazapytania_[i]!=NULL){
    		w = z2->u.zapproste_.tabliniazapytania_[i]->wyraz_;
		if(z1->u.zapproste_.tabliniazapytania_[i]==NULL)
		    z->u.zapproste_.tabliniazapytania_[i] = make_LiniaZap(z2->u.zapproste_.tabliniazapytania_[i]->ident_, w);
		else{
		    if (spojnik == SPOJNIK_AND) {
		        z->u.zapproste_.tabliniazapytania_[i] = make_LiniaZap(z2->u.zapproste_.tabliniazapytania_[i]->ident_, make_WyrazAnd(w, z1->u.zapproste_.tabliniazapytania_[i]->wyraz_));
		    }
		    else {
		    	 z->u.zapproste_.tabliniazapytania_[i] = make_LiniaZap(z2->u.zapproste_.tabliniazapytania_[i]->ident_, make_WyrazOr(w, z1->u.zapproste_.tabliniazapytania_[i]->wyraz_));
		    }
		}
	  }else
	    z->u.zapproste_.tabliniazapytania_[i] = z1->u.zapproste_.tabliniazapytania_[i];
	}
	return z;
    }
    return NULL;
}

void contextZapytanie(Zapytanie _p_,int iii)
{
  Zapytanie zapyt;
  int i;
  switch(_p_->kind)
  {
  case is_ZapProste:
    /* Code for ZapProste Goes Here */
      if(!firstZapProste || iii==0){
          firstZapProste = _p_;
          break;
      }
      firstZapProste = polacz_zapytania(_p_, firstZapProste, SPOJNIK_OR);
    break;
  case is_ZapDef:
    /* Code for ZapDef Goes Here */
    contextZapytanie(_p_->u.zapdef_.zapytanie_,0);
    contextNazwa(_p_->u.zapdef_.nazwa_);
    symbols_set_zapyt(_p_->u.zapdef_.nazwa_, _p_->u.zapdef_.zapytanie_);
    break;
  case is_ZapWyw:
    /* Code for ZapWyw Goes Here */
    //TODO: PoÅ‚Ä…czyÄ‡ linie zapytania z zap_def
    contextZapytanie(_p_->u.zapwyw_.zapytanie_,0);
    contextNazwa(_p_->u.zapwyw_.nazwa_);
    zapyt = symbols_get_zapyt(_p_->u.zapwyw_.nazwa_);
    if(zapyt==NULL){
	//TODO: komunikat
	exit(1);
    }
    //TODO: zdefiniowaÄ‡ funkcjÄ™
    zapyt = polacz_zapytania(_p_->u.zapwyw_.zapytanie_, zapyt, SPOJNIK_AND);
    if(zapyt)
      _p_->u.zapwyw_.zapytanie_ = zapyt;
    break;
  case is_ZapPuste:
    /* Code for ZapPuste Goes Here */
    break;

  default:
    fprintf(stderr, "Error: bad kind field when printing Zapytanie!\n");
    exit(1);
  }
}

void contextLiniaZapytania(LiniaZapytania _p_)
{

    /* Code for LiniaZap Goes Here */
    contextNazwaPola(_p_->ident_);
    contextWyraz(_p_->wyraz_);

}

void contextWyraz(Wyraz _p_)
{
  switch(_p_->kind)
  {
  case is_WyrazAnd:
    /* Code for WyrazAnd Goes Here */
    contextWyraz(_p_->u.wyrazand_.wyraz_1);
    contextWyraz(_p_->u.wyrazand_.wyraz_2);
    break;
  case is_WyrazOr:
    /* Code for WyrazOr Goes Here */
    contextWyraz(_p_->u.wyrazor_.wyraz_1);
    contextWyraz(_p_->u.wyrazor_.wyraz_2);
    break;
  case is_WyrazNeg:
    /* Code for WyrazNeg Goes Here */
    contextWyraz(_p_->u.wyrazneg_.wyraz_);
    break;
  case is_WyrazFrag:
    /* Code for WyrazFrag Goes Here */
    contextTekst(_p_->u.wyrazfrag_.tekst_1);
    contextTekst(_p_->u.wyrazfrag_.tekst_2);
    break;
  case is_WyrazFragL:
    /* Code for WyrazFragL Goes Here */
    contextTekst(_p_->u.wyrazfragl_.tekst_);
    break;
  case is_WyrazFragP:
    /* Code for WyrazFragP Goes Here */
    contextTekst(_p_->u.wyrazfragp_.tekst_);
    break;
  case is_WyrazTekst:
    /* Code for WyrazTekst Goes Here */
    contextTekst(_p_->u.wyraztekst_.tekst_);
    break;

  default:
    fprintf(stderr, "Error: bad kind field when printing Wyraz!\n");
    exit(1);
  }
}

void contextListZapytanie(ListZapytanie listzapytanie)
{
  while(listzapytanie != 0)
  {
    /* Code For ListZapytanie Goes Here */
    contextZapytanie(listzapytanie->zapytanie_,1);
    listzapytanie = listzapytanie->listzapytanie_;
  }
}

void contextListLiniaZapytania(ListLiniaZapytania listliniazapytania)
{
  while(listliniazapytania != 0)
  {
    /* Code For ListLiniaZapytania Goes Here */
    contextLiniaZapytania(listliniazapytania->liniazapytania_);
    listliniazapytania = listliniazapytania->listliniazapytania_;
  }
}

void contextTekst(Tekst _p_)
{

}

void contextNazwa(Nazwa _p_)
{

}

void contextMytoken(MyToken p)
{
  /* Code for MyToken Goes Here */
}
void contextIdent(Ident i)
{
  /* Code for Ident Goes Here */
}

void contextNazwaPola(Ident i)
{
  if(symbols_is_NazwaPola(i)) fprintf(stderr, "Error: %s nie jest nazwÄ… pola\n", symbols_get_name(i));
}

void contextInteger(Integer i)
{
  /* Code for Integer Goes Here */
}
void contextDouble(Double d)
{
  /* Code for Double Goes Here */
}
void contextChar(Char c)
{
  /* Code for Char Goes Here */
}
void contextString(String s)
{
  /* Code for String Goes Here */
}

